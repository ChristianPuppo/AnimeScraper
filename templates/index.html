<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Anime Scraper</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <style>
        body {
            background-color: #1E1E1E;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .title {
            font-size: 24px;
            font-weight: bold;
        }
        .search-bar {
            background-color: #2C2C2E;
            border-radius: 10px;
            padding: 8px 16px;
            margin-bottom: 16px;
        }
        .search-input {
            background: transparent;
            border: none;
            color: white;
            width: 100%;
            font-size: 16px;
        }
        .search-input::placeholder {
            color: #8E8E93;
        }
        .search-input:focus {
            outline: none;
        }
        .recommended {
            font-size: 20px;
            font-weight: bold;
            color: #32D74B;
            margin-bottom: 16px;
        }
        .anime-card {
            background-color: #2C2C2E;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        .anime-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .anime-info {
            padding: 16px;
        }
        .anime-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .anime-seasons {
            font-size: 14px;
            color: #8E8E93;
        }
        .anime-rating {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #8E8E93;
        }
        .star-icon {
            color: #FFD700;
            margin-right: 4px;
        }
        .episode-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 16px;
        }
        .episode-button {
            background-color: #32D74B;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
        }
        .video-player {
            background-color: #2C2C2E;
            border-radius: 10px;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 16px;
        }
        .suggestions {
            background-color: #2C2C2E;
            border-radius: 10px;
            margin-top: -16px;
            margin-bottom: 16px;
            padding: 8px 0;
        }
        .suggestion-item {
            padding: 8px 16px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #3A3A3C;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }
        .error {
            background-color: #FF453A;
            color: white;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <span class="title">Anime Scraper</span>
            <span>by chrulx</span>
        </div>

        <div class="search-bar">
            <input v-model="query" @input="getSuggestions" @keyup.enter="searchAnime" class="search-input" placeholder="Search">
        </div>

        <div v-if="suggestions.length" class="suggestions">
            <div v-for="suggestion in suggestions" :key="suggestion.url" @click="selectSuggestion(suggestion)" class="suggestion-item">
                {{ suggestion.title }}
            </div>
        </div>

        <div v-if="error" class="error">{{ error }}</div>

        <div v-if="loading" class="loading">Caricamento...</div>

        <div v-if="!loading && !animeResults.length" class="recommended">Consigliati</div>

        <div v-for="anime in animeResults" :key="anime.url" class="anime-card">
            <img :src="anime.thumbnail" :alt="anime.title" class="anime-image">
            <div class="anime-info">
                <div class="anime-title">{{ anime.title }}</div>
                <div v-if="anime.seasons" class="anime-seasons">{{ anime.seasons }} Stagioni</div>
                <div v-if="anime.rating" class="anime-rating">
                    <span class="star-icon">★</span>
                    {{ anime.rating }}
                </div>
                <div v-if="anime.episodes" class="episode-grid">
                    <button v-for="episode in anime.episodes" :key="episode.url" class="episode-button" @click="getStreamingUrl(episode.url)">
                        {{ episode.title }}
                    </button>
                </div>
            </div>
        </div>

        <div v-if="videoUrl" class="video-player">
            <video controls :src="videoUrl" style="width: 100%; height: 100%;"></video>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                query: '',
                animeResults: [],
                suggestions: [],
                videoUrl: '',
                loading: false,
                error: null
            },
            methods: {
                async searchAnime() {
                    this.loading = true;
                    this.error = null;
                    this.suggestions = [];
                    try {
                        const response = await axios.post('/search', { query: this.query });
                        this.animeResults = response.data;
                    } catch (error) {
                        console.error('Error searching anime:', error);
                        this.error = 'Si è verificato un errore durante la ricerca. Riprova più tardi.';
                    } finally {
                        this.loading = false;
                    }
                },
                async getSuggestions() {
                    if (this.query.length < 3) {
                        this.suggestions = [];
                        return;
                    }
                    try {
                        const response = await axios.post('/search_suggestions', { query: this.query });
                        this.suggestions = response.data;
                    } catch (error) {
                        console.error('Error getting suggestions:', error);
                    }
                },
                selectSuggestion(suggestion) {
                    this.query = suggestion.title;
                    this.searchAnime();
                },
                async getEpisodes(animeUrl) {
                    this.loading = true;
                    this.error = null;
                    try {
                        const response = await axios.post('/episodes', { anime_url: animeUrl });
                        const index = this.animeResults.findIndex(anime => anime.url === animeUrl);
                        if (index !== -1) {
                            this.animeResults[index].episodes = response.data;
                            this.$forceUpdate();
                        }
                    } catch (error) {
                        console.error('Error getting episodes:', error);
                        this.error = 'Si è verificato un errore durante il recupero degli episodi. Riprova più tardi.';
                    } finally {
                        this.loading = false;
                    }
                },
                async getStreamingUrl(episodeUrl) {
                    this.loading = true;
                    this.error = null;
                    try {
                        const response = await axios.post('/stream', { episode_url: episodeUrl });
                        this.videoUrl = response.data.video_url;
                    } catch (error) {
                        console.error('Error getting streaming URL:', error);
                        this.error = 'Si è verificato un errore durante il recupero dello streaming. Riprova più tardi.';
                    } finally {
                        this.loading = false;
                    }
                }
            }
        });
    </script>
</body>
</html>